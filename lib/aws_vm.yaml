tosca_definitions_version: tosca_simple_yaml_1_3

imports:
    - repository: unfurl
      file: tosca_plugins/artifacts.yaml

node_types:
    aws.vm:
        derived_from: unfurl.nodes.Installer.Terraform

        properties:
            instance_name:
                type: string

            instance_type:
                type: string
                default: t2.micro

            application_port:
                type: integer
                default: 7776

            aws_access_key:
                type: string
                default: {get_input: aws_access_key}

            aws_secret_key:
                type: string
                default: {get_input: aws_secret_key}

            aws_session_token:
                type: string
                default: {get_input: aws_session_token}
                required: false

            aws_region:
                type: string
                default: {get_input: aws_region}

            aws_ssh_key_name:
                type: string
                default: {get_input: aws_ssh_key_name}

        attributes:
            public_address:
                type: string

            public_ip:
                type: string

        capabilities:
            host:
                type: tosca.capabilities.Compute

        interfaces:
            Standard:
                operations:
                    configure:
                    delete:
            defaults:
                outputs:
                    public_ip: public_ip
                    public_address: public_address
                inputs:
                    tfvars: |
                        aws_access_key = "{{ SELF.aws_access_key }}"
                        aws_secret_key = "{{ SELF.aws_secret_key }}"
                        aws_session_token = "{{ SELF.aws_session_token }}"
                        aws_region = "{{ SELF.aws_region }}"
                        instance_name = "{{ SELF.instance_name }}"
                        instance_type = "{{ SELF.instance_type }}"
                        key_name = "{{ SELF.aws_ssh_key_name }}"
                        application_port = {{ SELF.application_port }}
                    main: |
                        terraform {
                          required_version = ">= 0.14.0"
                          required_providers {
                            aws = {
                              source  = "hashicorp/aws"
                              version = "~> 5.0"
                            }
                          }
                        }

                        provider "aws" {
                          region     = var.aws_region
                          access_key = var.aws_access_key
                          secret_key = var.aws_secret_key
                          token      = var.aws_session_token
                        }

                        variable "aws_access_key" {
                          type = string
                        }

                        variable "aws_secret_key" {
                          type = string
                        }

                        variable "aws_session_token" {
                          type    = string
                          default = ""
                        }

                        variable "aws_region" {
                          type = string
                        }

                        variable "instance_name" {
                          type = string
                        }

                        variable "instance_type" {
                          type = string
                        }

                        variable "key_name" {
                          type = string
                        }

                        variable "application_port" {
                          type = number
                        }

                        # Get latest Ubuntu 22.04 AMI
                        data "aws_ami" "ubuntu" {
                          most_recent = true
                          owners      = ["099720109477"] # Canonical

                          filter {
                            name   = "name"
                            values = ["ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"]
                          }

                          filter {
                            name   = "virtualization-type"
                            values = ["hvm"]
                          }
                        }

                        # Security Group
                        resource "aws_security_group" "app_sg" {
                          name        = "${var.instance_name}-sg"
                          description = "Security group for ${var.instance_name}"

                          ingress {
                            description = "SSH"
                            from_port   = 22
                            to_port     = 22
                            protocol    = "tcp"
                            cidr_blocks = ["0.0.0.0/0"]
                          }

                          ingress {
                            description = "HTTP"
                            from_port   = 80
                            to_port     = 80
                            protocol    = "tcp"
                            cidr_blocks = ["0.0.0.0/0"]
                          }

                          ingress {
                            description = "HTTPS"
                            from_port   = 443
                            to_port     = 443
                            protocol    = "tcp"
                            cidr_blocks = ["0.0.0.0/0"]
                          }

                          ingress {
                            description = "Application Port"
                            from_port   = var.application_port
                            to_port     = var.application_port
                            protocol    = "tcp"
                            cidr_blocks = ["0.0.0.0/0"]
                          }

                          ingress {
                            description = "PostgreSQL"
                            from_port   = 5432
                            to_port     = 5432
                            protocol    = "tcp"
                            cidr_blocks = ["0.0.0.0/0"]
                          }

                          egress {
                            from_port   = 0
                            to_port     = 0
                            protocol    = "-1"
                            cidr_blocks = ["0.0.0.0/0"]
                          }

                          tags = {
                            Name = "${var.instance_name}-sg"
                          }
                        }

                        # EC2 Instance
                        resource "aws_instance" "app_instance" {
                          ami                    = data.aws_ami.ubuntu.id
                          instance_type          = var.instance_type
                          key_name               = var.key_name
                          vpc_security_group_ids = [aws_security_group.app_sg.id]

                          tags = {
                            Name = var.instance_name
                          }

                          root_block_device {
                            volume_size = 20
                            volume_type = "gp2"
                          }
                        }

                        output "public_address" {
                          value = aws_instance.app_instance.public_ip
                        }

                        output "public_ip" {
                          value = aws_instance.app_instance.public_ip
                        }